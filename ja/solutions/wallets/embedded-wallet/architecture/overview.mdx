---
title: 概要
description: web3ゲーミングのためのSequenceインフラストラクチャスタックにおける組み込みウォレットアーキテクチャのドキュメント。
sidebarTitle: 概要
---

## 組み込みウォレットアーキテクチャ

Sequence組み込みウォレットはネイティブなスマートコントラクトマルチシグウォレットです。マルチシグの設定は2/2で、トランザクションを送信するには両方の当事者の署名が必要です。

鍵が最初に一緒に作成されてから分離される従来のMPCアーキテクチャとは異なり、Sequence WaaS鍵は常に分離されたままで、署名のために組み合わせる必要はありません。

このコアセキュリティ層の上に、Sequence WaaSアーキテクチャは追加の保護を提供します：

* **Sequence Auth:** 暗号化されたAWS Nitro Enclaveで実行され、Sequence Authは最初の署名者として機能し、Quantstampによって公開監査された最新バージョンにロックされています。SequenceはQuantstampの承認なしにエンクレーブにアクセスしたり、更新をプッシュしたりする能力を持っていません。
* **Sequence Guard:** Sequence Authから独立して実行され、トランザクションに署名する前にユーザーのIDと意図の両方を確認することができます。
* **OpenID Connect互換性:** Sequence WaaSは、Google、Appleおよび同じプロトコルに従う他のプロバイダーなど、確立されたOpenID Connectプロバイダーを活用します。市場の他のソリューションとは異なり、WaaSは開発者が自身のOIDC識別子をこれらのサービスで活用することも可能にします。

## Sequence Auth

Sequence Authは[AWS Nitro Enclaves](https://aws.amazon.com/ec2/nitro/nitro-enclaves/)プラットフォーム上で実行されるAPIサービスで、ユーザーウォレットごとの2/2マルチシグ構成に貢献する認証署名者を提供します。Sequence Authは、アプリケーションにアカウント作成、ログイン、セッション管理、およびウォレットサポートを追加する簡単な方法を提供し、従来のウェブ体験（ソーシャルログイン、メールログインなど）を提供しながら、スマートコントラクトと対話するための暗号ウォレットへのアクセスを可能にします。

### WaaS設定キー

新しいインスタンスごとに、WaaS設定キーがアプリまたはゲームクライアントの認証に使用されます。これにより、WaaS SDKを通じてSequence Authに送信された生成されたインテントを介してブロックチェーンへのアクセスが提供されます。設定キー内で複数のログインプロバイダークライアントIDを登録でき、それぞれがプロバイダーごとに生成されるウォレットアドレスを決定します。これは、ログインプロバイダー（GoogleやAppleなど）のクライアントIDがインスタンス間で共有されている場合、同じログインプロバイダーを同じ認証情報で使用するユーザーは同じアドレスを生成することを意味します。

### ウォレットの秘密鍵

ウォレットの秘密鍵は、SequenceとQuantstampの間で分割された責任戦略を使用して暗号化されて保存されます：

1. Sequenceは、データベースに保存された暗号化されたブロブにのみアクセスでき、復号化する手段はありません。
2. Quantstampは[KMS](https://aws.amazon.com/kms/)（AWSハードウェアセキュリティモジュール）を所有および運営しており、これはウォレットキーデータの暗号化に使用されます。彼らはキー材料をエクスポートする方法も、暗号化されたデータ自体へのアクセスも持っていません。

### Waas Enclave

WaaS Enclaveは暗号化されたウォレットデータを使用できる唯一のエンティティです。そのセキュリティは以下によって保証されています：

1. AWS Nitroハイパーバイザーは、実際に実行されているエンクレーブコードに基づいて暗号化された証明を生成し署名します。このドキュメントには、Amazon公開鍵インフラストラクチャによって署名されたPCR0（エンクレーブコードのハッシュ）が含まれています。
2. 信頼できる第三者が運営するKMSは、証明が有効で、エンクレーブのPCR0ハッシュが期待値と一致する場合にのみ、暗号化操作へのアクセスを許可するポリシーを指定します。これは、エンクレーブへのわずかな変更でも、異なる証明とPCR0ハッシュが生成され、効果的に無効化されることを意味します。
3. エンクレーブコードはオープンソースであり、誰でも監査して、サービスが監査済みのソースコードの正確なバージョンを使用していることを確認できます。[検証についてさらに学ぶ](/solutions/wallets/embedded-wallet/architecture/enclave-verification)。

Sequence Authのソースコードは[公開されており、独立して監査されています](https://github.com/0xsequence/waas-authenticator)。また、上記の保護措置により、いかなる当事者による改ざんも防止されています。

## Sequence Guard

Sequence Guardは、Sequenceによってホストされるサービスで、ウォレットごとの2/2構成に貢献するウォレットのもう一つの鍵です。これは別の防衛線として機能し、ユーザーの*アイデンティティ*だけでなく*意図*も確認します。これは2つの異なる方法で実現されます：

1 - 制限とアローリスト：開発ダッシュボードから、どのような行動が許可されるかを設定できます。これは、ガードがこれらの制約内のトランザクションにのみ署名することを意味します。例えば、NFTコントラクトXのみが呼び出し可能と定義すると、ガードは他のトランザクションが実行されないように強制します。

2 - ユーザーの認証：Sequence Guardは**Sequence Authとは独立して**ユーザーを認証します。この認証は、第三者のOAuth 2.0 IDトークン（Meta、Google、Xなど）を使用するか、メール/電話番号を通じてOTPコードで直接ユーザーとコミュニケーションを取ることで実行されます。直接のコミュニケーションは常に必要というわけではなく、必要な場合でも、シームレスでプロジェクトの詳細でブランド化されています。

### 脅威モデル

これらの保護措置により、ウォレットは**安全**で、以下のシナリオに対応できます：

1. Sequence.appのバックエンドが侵害される、またはガードキーが漏洩した場合：このシナリオでは、ユーザーの身元はSequence Authによって引き続き確認される必要があります。

2. Sequence Authが侵害された場合：このシナリオではSequence Guardがウォレットを保護します。Sequence Guardは独立してユーザーを認証するため、攻撃者はこのシナリオではウォレットにアクセスできません。

このモデルは以下のシナリオに対しても部分的な保護を提供します：

3. パートナーのフロントエンドが侵害される、またはパートナー側でMITMが発生した場合：攻撃者がパートナーのフロントエンドを侵害できた場合、ログイン時にウォレットにアクセスできる可能性がありますが、現在非アクティブなユーザーのウォレットにはアクセスできません。これは、このようなシナリオからの復旧が限定的な被害で可能であることを意味します。

## 簡略化されたデータフロー

以下では、組み込みウォレットを介したトランザクションの署名などの一般的なユースケースのデータフローを説明します。

<Frame>
  ![data-flow-architecture](/images/diagrams/waas/waas-flow.png)
</Frame>

<Note>
  WaaSシステムにおけるトランザクションのライフサイクルを説明する簡略化されたレイアウト。
  青：パートナーが提供するソフトウェア
  オレンジ：Sequenceが提供し、パートナーが実行・管理するソフトウェア
  黄：Sequenceが提供し、安全なAWS Nitro Enclaveで実行するソフトウェア
  緑：Sequenceが提供・実行するソフトウェア
</Note>

#### 1. インテントの生成

ユーザーはクライアントと対話して、ウォレットの代わりにアクション（USDCの送信やコントラクトメソッドの呼び出しなど）を「実行」します。

クライアントは`WaaS SDK`にそのアクションのインテントの生成を要求します。このインテントはクライアントのセッションキーで署名されます。このセッションキーは、そのOAuthセッションが有効な間のみ有効な生成されたキーです。WaaSバックエンドに送信されるすべてのインテントは、まずこのセッションキーで署名され、ユーザー側でアクティブな認証済みセッションが存在することを確認します。

#### 2. SDKがSequence Authにインテントを転送

インテントとそれに対応する署名は、AWS Nitro Enclaveで実行されているSequence Authサービスに送信されます。
Sequence AuthはWaaS APIに対して、与えられたインテントのトランザクションを構築するよう要求し、そのトランザクションが元のインテントから逸脱していないことを確認します。検証が成功すると、Sequence Authはトランザクションに署名し、トランザクション、インテント、署名をWaaS APIに転送します。

#### 4. WaaS APIがSequence Guardから署名を収集

WaaS APIは「半署名」されたトランザクションリクエストと、クライアントによって署名されたインテントを受け取ります。トランザクションを中継する前にもう1つの署名を収集する必要があるため、Sequence Guardを呼び出します。

#### 5. Sequence Guardがユーザーを認証

Sequence Guardは特定のウォレットの署名リクエストを受け取ります。インテントが存在し、トランザクションに対応しており、有効なセッションによって署名されていることを確認します。すべてが正しければ、トランザクションに署名します。

#### 6. 中継とトランザクションレシート

WaaS APIはトランザクションを中継し、レシートを待ちます。結果の`txHash`はクライアントに返されます。
