---
title: DuneでのSequenceアナリティクスAPI
description: サーバーレスのCloudflare Workerを使用してプロジェクトのユーザーデータを
  クエリするSequence Builderのアナリティクス機能の使用方法を学びます。
sidebarTitle: DuneでSequenceアナリティクスAPIを活用する
---

所要時間：20-30分

このガイドでは、[Sequence Builder](https://sequence.build/)のアナリティクス機能を使用して、サーバーレスの[Cloudflare Worker](https://www.cloudflare.com/).

コミュニティにあなたの成果をアピールするために[Dune](https://dune.com/)ダッシュボードを使用して連携感を与えるか、ユーザー分析によって駆動されるインテリジェントなフィードバックループをゲームに組み込むためにAPIを活用してください。

このガイドの出力例は[こちら](https://dune.com/mmhorizon/dungeon-minter-analytics)

1. アクセスキー管理：Sequenceスタックと対話するための秘密アクセスキーを取得
2. Cloudflare Worker：Sequenceスタックにクエリを実行し、プロジェクト固有のデータポイントを生成する関数を作成
3. Duneダッシュボード：共有可能なダッシュボードとしてデータのビューを作成

<Note>
  テンプレートコードの参照は[こちら](https://github.com/0xsequence-demos/template-cloudflare-worker-wallets-analytics)
</Note>

## 1. アクセスキー管理

Sequenceスタックでアプリケーションを認証するために、プロジェクトの秘密アクセスキーを取得する必要があります。以下の手順に従ってください：

### 秘密アクセスキーの作成

<Steps>
  <Step title="Access Settings">
    まず設定にアクセスし、APIキーカードを選択します：

    <Frame>
      ![builder settings access keys](/images/builder/builder_settings_access_keys.png)
    </Frame>
  </Step>

  <Step title="Add Service Account">
    下にスクロールして選択`+ Add Service Account`：

    <Frame>
      ![builder settings add service account](/images/builder/builder_settings_add_service_account.png)
    </Frame>
  </Step>

  <Step title="Select Write Permission">
    次に権限を変更して`Write`、クリックして`+ Add Service Account`、そして選択`Confirm`：

    <Frame>
      ![builder settings add service account](/images/builder/builder_settings_add_service_account_confirm.png)
    </Frame>

    最後に`copy`キーを安全な場所に保存してください。Sequence Builderから将来このキーにアクセスすることはできません。
  </Step>
</Steps>

## 2. Cloudflare Worker

この例では、ダッシュボードの使用に基づく自動スケーリングとCLIからの簡単なデプロイメントを体験するためにCloudflare Workerを使用しますが、もちろん独自のバックエンドや他のサーバーレスの代替手段を使用することもできます。

<Steps>
  <Step title="Create Project">
    プロジェクトを最初から作成するには、まずプロジェクトを作成して`mkdir`、`cd`プロジェクトに移動し、`pnpm init`を実行して`package.json`を作成します。
  </Step>

  <Step title="'Hello World' Worker">
    wrangler cliがプロジェクトにインストールされていることを確認し、`wrangler`キーワードをローカルbashセッションのエイリアスとして設定します。

    ```shell
    pnpm install wrangler --save-dev
    alias wrangler='./node_modules/.bin/wrangler'
    ```

    アカウントを作成[Cloudflareサイト](https://cloudflare.com/)でCloudflareダッシュボードにログインして、Cloudflareプラットフォームをローカル開発環境に接続します。

    ```shell
    wrangler login
    ```

    ログインしたら、ディレクトリでコマンド`wrangler init`を使用してプロジェクトを初期化し、提供されたランダムに生成されたプロジェクトフォルダ名の中から好きなものを選択し、プロンプトに従ってgitで追跡されるtypescript`"Hello World" Worker`アプリケーションを初期化します。

    ```shell
    wrangler init
    ```

    このステップを完了するには、`wrangler init`の後にEnterを4回押し、最後の2ステップは`No`と答えてgitバージョン管理とデプロイメントを拒否します。

    これにより、クラウドにコードをデプロイするために使用できるスターターリポジトリがクローンされます。

    <Note>
      ローカルAPIテスト<br />

      ガイドのどの時点でも、`wrangler dev`コマンドをプロジェクトフォルダで使用してローカルテストができます
    </Note>

    #### デプロイテスト

    最後に、`cd`ランダムに生成されたプロジェクトフォルダに移動し、`wrangler deploy`コマンドを実行します。

    これによりURLが表示されるはずです。ブラウザでそのURLを`https://<app>.<account>.workers.dev`入力して`Hello World!`結果を表示できます。
  </Step>

  <Step title="Setup Config, Routes, & Mock functions">
    プロジェクトのセットアップが完了したら、`wrangler.toml`を以下の変数で更新します。ここで`DAYS`は調査対象の期間です：

    ```shell
    [vars]
    SECRET_API_ACCESS_KEY = "<SECRET_API_ACCESS_KEY>"
    PROJECT_ID = <PROJECT_ID>
    DAYS = <DAYS>
    ```

    次に`Env`タイプを変数と共に`index.ts`に含めます：

    ```ts
    export interface Env {
    	PROJECT_ID: number;
    	SECRET_API_ACCESS_KEY: string;
    	DAYS: number;
    }
    ```

    既存の`fetch`関数を以下のモック関数呼び出しに置き換えます：

    ```ts
    export default {
    	async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
    		const url = new URL(request.url);
    		
    		// Handle different endpoints
    		if (url.pathname === "/dailyActiveUsers") {
    			return handleDailyWallets(env, request);
    		} else if (url.pathname === "/totalTransactionsSent") {
    			return handleTotalTxns(env, request);
    		} else {
    			return new Response("No function for this URL", { status: 405 });
    		}
    	},
    };
    ```

    以下の関数を使用します：

    ```ts
    const handleDailyWallets = async (env: Env, request: Request) => {
    	return new Response(JSON.stringify({endpoint: 'daily'}), { status: 200 });
    }

    const handleTotalTxns = async (env: Env, request: Request) => {
    	return new Response(JSON.stringify({endpoint: 'total'}), { status: 200 });
    }
    ```
  </Step>

  <Step title="Date Formatting">
    次に、以下のユーティリティ関数を含めて、`wrangler.toml`内の`DAYS`変数の正しい日付を解析します：

    ```ts
    const endDate = () => {
    	const today = new Date();
    	return today.toISOString().substring(0, 10); // only including the YYYY-MM-DD date
    }

    const startDate = (env: Env) => {
    	const today = new Date();

    	// Format today's date as a string
    	const daysBefore = new Date(today);
    	daysBefore.setDate(daysBefore.getDate() - env.DAYS);
    	
    	// Format the date 7 days before as a string by only including the YYYY-MM-DD date
    	const daysBeforeString = daysBefore.toISOString().substring(0, 10);
    	return daysBeforeString
    }
    ```
  </Step>

  <Step title="Daily Active Users">
    次に、`Daily Active Users`リクエストを以下の関数を使用して処理し、Sequence Analytics APIを呼び出します：

    ```ts
    const handleDailyWallets = async (env: Env, request: Request) => {
    	const resp = await fetch(
    	`https://api.sequence.build/rpc/Builder/WalletsDaily`,
    		{
    			method: 'POST',
    			headers: {
    			'Content-Type': 'application/json',
    			'Authorization': `Bearer ${env.SECRET_API_ACCESS_KEY}`
    			},
    			body: JSON.stringify({
    			filter: {
    				dateInterval: 'DAY',
    				endDate: endDate(),
    				projectId: env.PROJECT_ID,
    				startDate: startDate(env)
    			}
    			})
    		}
    	)
    	
    	const data: any = await resp.json();
    	return new Response(JSON.stringify(data.walletStats), { status: 200 });
    }
    ```
  </Step>

  <Step title="Total Transactions Sent">
    最後に、以下の関数を`Total Transactions Sent`に追加します：

    ```ts
    const handleTotalTxns = async (env: Env, request: Request) => {
    	const resp = await fetch(
    	`https://api.sequence.build/rpc/Builder/WalletsTxnSentTotal`,
    		{
    		  method: 'POST',
    		  headers: {
    			'Content-Type': 'application/json',
    			'Authorization': `Bearer ${env.SECRET_API_ACCESS_KEY}`
    		  },
    		  body: JSON.stringify({
    			filter: {
    			  dateInterval: 'DAY',
    			  endDate: endDate(),
    			  projectId: env.PROJECT_ID,
    			  startDate: startDate(env)
    			}
    		  })
    		}
    	)
    	
    	const data: any = await resp.json();
    	return new Response(JSON.stringify(data.walletStats), { status: 200 });
    }
    ```
  </Step>

  <Step title="Included Spacing for Days of Zero Data">
    Sequence Analytics APIのレスポンスからはアクティビティがゼロの日は除外されています。ただし、Duneクエリでデータがゼロの日も含めて時間の間隔を表示したい場合は、以下の関数を使用して正しい日付形式でデータが表示されていない日を補完できます：

    ```typescript
    const fillMissingDates = (data: any[], startDate: string, endDate: string) => {
    	const filledData: { value: number, label: string }[] = [];
    	const start = new Date(startDate);
    	const end = new Date(endDate);
    	
    	for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    		const dateString = d.toISOString().substring(0, 10);
    		const existingData = data.find(entry => entry.label === dateString);
    		if (existingData) {
    			filledData.push(existingData);
    		} else {
    			filledData.push({ value: 0, label: dateString });
    		}
    	}
    	
    	return filledData;
    }
    ```

    そして**両方**の呼び出しレスポンスに以下のメソッド呼び出しを`walletStats`データと共に含めます：

    ```typescript
    	...
    	const data: any = await resp.json();
    	const filledData = fillMissingDates(data.walletStats, startDate(env), endDate());
    	return new Response(JSON.stringify(filledData), { status: 200 });
    }
    ```
  </Step>
</Steps>

これでホスト名を使用して各パスを呼び出すことでAPIをテストできます（`/dailyActiveUsers`と`/totalTransactionsSent`) を再デプロイした後に`wrangler deploy`。

<Note>
  Analytics APIを通じて利用可能なエンドポイントの詳細な例については、[概要](/api-references/analytics/overview)ページをご確認ください。
</Note>

## 3. Duneダッシュボード

<Steps>
  <Step title="Dune Sign Up">
    まず、[Dune](https://dune.com/)
  </Step>

  <Step title="Create Query">
    アカウントにアクセスして`https://dune.com/<account>`を選択し、`Create`ボタンと`New query`。

    <Frame>
      ![dune create query](/images/guides/analytics/dune_create_query.png)
    </Frame>
  </Step>

  <Step title="Daily Active Users Query">
    コンソールに以下のSQLクエリを入力し、`Run`を選択します：

    ```sql
    SELECT
      t.label as "Date", -- converting the label to "Date"
      t.value as "Count" -- converting the value field to "Count"
    FROM UNNEST(
      TRY_CAST(
        JSON_PARSE(HTTP_GET('https://<URL>/dailyActiveUsers')) AS ARRAY(ROW(label VARCHAR, value DOUBLE))
      )
    ) AS t(label, value)

    ```

    結果が返されたら、`New visualization`を作成します。

    次に、`Add visualization`をデフォルトの`Bar chart`がドロップダウンから選択された後に選択します（ただし、これはカスタマイズ可能です）。

    <Frame>
      ![add visualization](/images/guides/analytics/dune_add_visualization.png)
    </Frame>

    最後に、`Save`をクリックし、クエリに名前を付けます。

    <Frame>
      ![save query](/images/guides/analytics/dune_query_save.png)
    </Frame>
  </Step>

  <Step title="Total Transactions Sent Query">
    前のステップの[手順を繰り返し](/guides/analytics-guide#create-query)、以下のSQLクエリを使用します：

    ```sql
    SELECT
      t.label,
      t.value
    FROM UNNEST(
      TRY_CAST(
        JSON_PARSE(HTTP_GET('https://<URL>/totalTransactionsSent')) AS ARRAY(ROW(label VARCHAR, value DOUBLE))
      )
    ) AS t(label, value)

    ```

    結果が返されたら、`New visualization`を作成します。

    次に、`Add visualization`を選択し、`Counter`までスクロールしてAPIから返された絶対合計を表示するカウンターウィジェットを作成します。
  </Step>

  <Step title="Create New Dashboard">
    ボタンにアクセスして`Create`>`New dashboard`を選択し、新しいダッシュボードの名前を入力します。

    <Frame>
      ![dune create dashboard](/images/guides/analytics/dune_create_dashboard.png)
    </Frame>

    作成後、`Edit`と`Add visualization`を選択して前の2つのクエリを追加します。

    <Frame>
      ![dune edit dashboard](/images/guides/analytics/dune_edit_dashboard.png)
    </Frame>

    <Frame>
      ![dune add visualization from dashboard](/images/guides/analytics/dune_add_visualization_from_dashboard.png)
    </Frame>

    各クエリについて1回ずつ、モーダルで名前を検索し、`Add`を選択し、その後`Done`をモーダルで、`Done`をダッシュボードで選択します。
  </Step>
</Steps>

おめでとうございます。これでプロジェクトのデータ使用状況をチームやコミュニティと共有する準備が整いました。最後に`Share`ボタンをクリックして完了です。

<Frame>
  ![dune share dashboard](/images/guides/analytics/dune_share_dashboard.png)
</Frame>
